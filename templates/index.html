{% extends "base.html" %}

{% block head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
{% endblock %}

{% block content %}
<header>
    <h1>ðŸŽ‚ Birthday Reminder ðŸŽ‚</h1>
</header>

{% if upcoming_birthdays %}
<section class="next-birthday cheerful-highlight">
    <h2>ðŸŽˆðŸŽ‰ Upcoming Celebration! ðŸŽ‰ðŸŽˆ</h2>
    <div class="upcoming-names">
        {% for item in upcoming_birthdays %}
            <strong>{{ item.birthday.name }}</strong>{% if not loop.last %} & {% endif %}
        {% endfor %}
    </div>
    <p>Is happening in... <span class="countdown-days">
        {% if upcoming_birthdays[0].days_left == 0 %}ðŸ¥³ TODAY! ðŸ¥³{% else %}{{ upcoming_birthdays[0].days_left }} days!{% endif %}
    </span></p>
</section>
{% endif %}

<section class="add-birthday">
    <h2>Add Your Birthday</h2>
    <form method="POST" action="/">
        <div class="form-grid">
            <input type="text" name="name" placeholder="Name" required>
            
            <input type="date" name="dob" class="date-input" data-placeholder="Date of Birth" required>
            
            <input type="time" name="tob" class="date-input" data-placeholder="Time of Birth (for Fun facts!)" title="Time of Birth is for fun facts! (Private)" required>
            
            <input type="text" name="pob" placeholder="Place of Birth (for map)">
        </div>
        <textarea name="notes" placeholder="Gift ideas, notes..."></textarea>
        <button type="submit">Add Birthday</button>
    </form>
</section>

<section class="map-section">
    <h2>Birthplace Map</h2>
    <div id="map"></div>
</section>

<section class="list-birthdays">
    <h2>All Birthdays</h2>
    {% if sorted_birthdays %}
    <ul>
        {% for item in sorted_birthdays %}
        <li class="{% if item.days_left == 0 %}birthday-today{% elif item.days_left <= 7 %}birthday-upcoming{% endif %}">
            <div class="birthday-info">
                <strong>{{ item.birthday.name }} (turning {{ item.age_turning }})</strong>
                <span class="date">{{ item.birthday.dob.strftime('%b %d, %Y') }}</span>
                {% if item.birthday.notes %}<p class="notes">Notes: {{ item.birthday.notes }}</p>{% endif %}
            </div>
            <div class="birthday-actions">
                <span class="days-left">
                   {% if item.days_left == 0 %}Today!{% else %}{{ item.days_left }} days{% endif %}
                </span>
                {% if current_user.id == item.birthday.user_id or current_user.email == 'jithesh882006@gmail.com' %}
                    <a href="/edit/{{ item.birthday.id }}" class="edit-btn">Edit</a>
                    <a href="/delete/{{ item.birthday.id }}" class="delete-btn" onclick="return confirm('Are you sure?');">Delete</a>
                {% endif %}
            </div>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="empty-state">No birthdays yet. Be the first to add one!</p>
    {% endif %}
</section>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        const birthdays = {{ birthdays_json | tojson }};
        birthdays.forEach(birthday => {
            const marker = L.marker([birthday.lat, birthday.lon]).addTo(map);
            marker.bindTooltip(birthday.name, {permanent: true, direction: 'top', offset: [0, -10]}).openTooltip();
            const wikiUrl = `https://en.wikipedia.org/wiki/${encodeURIComponent(birthday.pob)}`;
            const popupContent = `<b>${birthday.name}</b><br>Born in: ${birthday.pob}<br><a href="${wikiUrl}" target="_blank">Learn more!</a>`;
            marker.bindPopup(popupContent);
        });
    });
</script>
{% endblock %}